# Teller App - Manager Briefing

**Project**: Teller - Saudi News App with TikTok-style vertical swipe feed
**Owner**: Mohammad
**Last Updated**: 2026-01-20
**Status**: Active Development

---

## Session Log: Subscription Grand Slam Offer Redesign

### Problem Statement
Mohammad reviewed the subscription page and identified critical issues:
1. Pricing was inconsistent (showed SAR 16 in value stack, SAR 25 on button)
2. Offer was not compelling ("not grand slam, I did not say wow")
3. Free trial was only 7 days (wanted 1 month)
4. Feature descriptions were unclear
5. Value stack numbers were unbelievable (SAR 120 total)
6. Fake social proof ("32,000+ professionals") - dishonest

### Team Deployed
- **Hormozi**: Grand Slam Offer framework, value equation, headline copy
- **Bee**: Visual hierarchy, scannability, typography
- **majnon**: Psychology triggers, FOMO, identity aspiration

---

## Changes Made

### 1. Pricing Fixed (Consistent SAR 16)

**Files Modified**:
- `app/subscription.tsx`
- `lib/payments/moyasar.ts`

| Item | Before | After |
|------|--------|-------|
| Monthly Price | SAR 25 | **SAR 16** |
| Annual Price | SAR 240 | **SAR 150** |
| Annual Savings | 20% | **22%** |

**Code Changes in `moyasar.ts`**:
```typescript
premium: {
  price: 1600, // halalas (SAR 16)
  priceDisplay: 'SAR 16/month',
  priceDisplayAr: '16 Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±',
}

premium_annual: {
  price: 15000, // halalas (SAR 150)
  priceDisplay: 'SAR 150/year (Save 22%)',
  priceDisplayAr: '150 Ø±ÙŠØ§Ù„/Ø³Ù†Ø© (ÙˆÙØ± 22%)',
}
```

---

### 2. Free Trial Extended to 30 Days

**Before**:
```
"7 Days Free â€¢ No Commitment"
```

**After**:
```
"30 Days Free â€¢ Full Month!"
```

**Arabic**:
```
"30 ÙŠÙˆÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹ â€¢ Ø´Ù‡Ø± ÙƒØ§Ù…Ù„!"
```

---

### 3. Hero Headline Rewritten

**Before** (weak):
```
"Your Time Is Too Valuable"
"Read the top news in 60 seconds instead of an hour"
```

**Rejected Options**:
- "Know Everything. Read Nothing." - Dishonest (they DO read)
- "Never Be the Last to Know" - Good but not Mohammad's vision

**Final (Mohammad's direction)**:
```
EN: "Stay Informed in 5 Minutes"
AR: "ÙƒÙ† Ø¹Ù„Ù‰ Ø§Ø·Ù„Ø§Ø¹ ÙÙŠ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚"

EN: "All the topics you care about. Every morning."
AR: "ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ùƒ. ÙƒÙ„ ØµØ¨Ø§Ø­."
```

---

### 4. Value Stack Rewritten

**Before** (confusing, unbelievable):
| Feature | Text | Value |
|---------|------|-------|
| Summary | "60-Second Daily Summary" | SAR 50 |
| WhatsApp | "WhatsApp Weekly Digest" | SAR 30 |
| No Ads | "Zero Ads Forever" | SAR 15 |
| AI | "AI Personalized For You" | SAR 25 |
| **Total** | | **SAR 120** |
| Savings | | 79% OFF |

**After** (clear, believable):
| Feature | Text | Value |
|---------|------|-------|
| Summary | "AI Daily News Briefing" | SAR 20 |
| WhatsApp | "Weekly WhatsApp Summary" | SAR 10 |
| No Ads | "Ad-Free Experience" | SAR 10 |
| AI | "News Tailored to Your Interests" | SAR 10 |
| **Total** | | **SAR 50** |
| Savings | | **68% OFF** |

---

### 5. Fake Social Proof Removed

**Before** (lie):
```
"32,000+ professionals get their daily summary"
```

**After** (honest value prop):
```
EN: "Save 1 hour daily from news browsing"
AR: "ÙˆÙÙ‘Ø± Ø³Ø§Ø¹Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† ØªØµÙØ­ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±"
```

---

### 6. Grand Slam Elements Added

#### Money-Back Guarantee
```tsx
<View style={styles.guaranteeBanner}>
  <FontAwesome name="shield" size={16} color={colors.success} />
  <Text>30-Day Money-Back Guarantee - No Questions Asked</Text>
</View>
```

#### Urgency Banner
```tsx
<View style={styles.urgencyBanner}>
  <FontAwesome name="clock-o" size={14} color={colors.warning} />
  <Text>Free month offer for limited time only</Text>
</View>
```

#### CTA Updated
**Before**: "Start 7-Day Free Trial"
**After**: "Start Your Free Month Now"
**Subtext**: "Then SAR 16/month â€¢ Cancel anytime"

---

### 7. New Styles Added

```typescript
guaranteeBanner: {
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  gap: spacing.sm,
  backgroundColor: 'rgba(52, 199, 89, 0.1)',
  borderWidth: 1,
  borderColor: colors.success,
  borderRadius: borderRadius.md,
  padding: spacing.md,
  marginBottom: spacing.lg,
},

urgencyBanner: {
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  gap: spacing.xs,
  marginBottom: spacing.md,
},
```

---

## Final Offer Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ 30 Days Free â€¢ Full Month!           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    âœ¨                           â”‚
â”‚       Stay Informed in 5 Minutes                â”‚
â”‚  All the topics you care about. Every morning. â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Everything You Get:                            â”‚
â”‚  âœ“ AI Daily News Briefing         SAR 20       â”‚
â”‚  âœ“ Weekly WhatsApp Summary        SAR 10       â”‚
â”‚  âœ“ Ad-Free Experience             SAR 10       â”‚
â”‚  âœ“ News Tailored to Your Interests SAR 10     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  Total Value:                     SAR 50       â”‚
â”‚  Your Price:        SAR 16/month  [68% OFF]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â±ï¸ Save 1 hour daily from news browsing       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ›¡ï¸ 30-Day Money-Back Guarantee                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     [ Start Your Free Month Now ]              â”‚
â”‚     Then SAR 16/month â€¢ Cancel anytime         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â° Free month offer for limited time only     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files Modified

| File | Changes |
|------|---------|
| `app/subscription.tsx` | Hero, value stack, pricing, guarantee, urgency, CTA |
| `lib/payments/moyasar.ts` | Price from 2500â†’1600 halalas, annual 24000â†’15000 |

---

## Previous Session: Feed UX Polish (5 Fixes)

Also completed in this session:

1. **Summary button text**: "Summary" â†’ "AI Summary"
2. **Summary button contrast**: Light bg â†’ Dark bg with border
3. **Onboarding back button**: Added X close button
4. **Topic chips**: Made tappable for single-topic filtering
5. **Removed "Teller" text**: Cleaned up header

---

## Principles Followed

- **No lies**: Removed fake "32,000+ professionals" claim
- **Honest pricing**: All numbers consistent and believable
- **Clear copy**: No jargon, users understand immediately
- **Grand Slam elements**: Guarantee, urgency, risk reversal
- **Mohammad's voice**: Used his direction for headline

---

## Next Steps

- Test subscription flow end-to-end
- Verify Moyasar payment processing with new prices
- A/B test headline variations if needed
- Monitor conversion rates after launch

---

*Documented by m7zm - Manager*

---

## Session Log: RSS Sources & Arabic Content Pipeline (2026-01-15)

### Problem Statement
User reported:
1. "Nothing on my feed" - User had seen all 673 stories (753 interactions)
2. "Sources have 0 stories" - `rss_sources` table was EMPTY
3. "I need all the Arabic sources" - Only 3 Arabic sources existed

### Root Causes Identified
1. **Empty feed**: User exhausted all available content (caught up state)
2. **No stories**: `rss_sources` table empty - RSS fetch function reads from this table
3. **Few Arabic sources**: Initial seeding was incomplete

### Solutions Implemented

#### 1. Feed Reset Feature
Added "caught up" state with reset button for users who've seen all stories.

**Files Modified**:
- `lib/api.ts` - Added `resetFeedHistory()` function
- `app/(tabs)/feed.tsx` - Added caught up UI with reset button

**New RLS Policy**:
```sql
CREATE POLICY "Users can delete own interactions" ON user_story_interactions
  FOR DELETE USING (auth.uid() = user_id);
```

#### 2. RSS Sources Seeding
Created comprehensive RSS sources database.

**Migrations Created**:
| Migration | Purpose |
|-----------|---------|
| `20260115000004_add_interactions_delete_policy.sql` | RLS for feed reset |
| `20260115000005_seed_all_rss_sources.sql` | Initial seeding |
| `20260115000006_fix_rss_urls.sql` | Verified working URLs |
| `20260115000007_arabic_sources.sql` | 73 Arabic sources |
| `20260115000008_fix_arabic_rss_urls.sql` | Disable 42 broken Arabic URLs |
| `20260115000009_google_news_arabic_feeds.sql` | Google News workaround |
| `20260115000010_disable_broken_english_sources.sql` | Disable 10 broken English URLs |

#### 3. Google News Workaround
Major Arabic sites block direct RSS. Used Google News RSS as proxy:
```
https://news.google.com/rss/search?q=site:DOMAIN&hl=ar&gl=SA&ceid=SA:ar
```

**Sources Added via Google News**:
- Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Al Arabiya)
- Ø§Ù„Ø¬Ø²ÙŠØ±Ø© (Al Jazeera)
- Ø³ÙƒØ§ÙŠ Ù†ÙŠÙˆØ² Ø¹Ø±Ø¨ÙŠØ© (Sky News Arabia)
- Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø· (Asharq Al-Awsat)
- Ø§Ù„Ø´Ø±Ù‚ (Asharq)
- ÙƒÙˆØ±Ø© (Kooora)
- ÙÙŠÙ„Ø¬ÙˆÙ„ (FilGoal)
- MBC

### Final RSS Sources Status

| Language | Active | Disabled |
|----------|--------|----------|
| Arabic | 39 | 42 |
| English | 26 | 10 |
| **Total** | **65** | 52 |

### Arabic Sources by Category (39 Working)

| Category | Sources |
|----------|---------|
| News | BBC Ø¹Ø±Ø¨ÙŠ, RT Arabic, DW Ø¹Ø±Ø¨ÙŠ, ÙØ±Ø§Ù†Ø³ 24 |
| News (Google) | Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù„Ø¬Ø²ÙŠØ±Ø©, Ø³ÙƒØ§ÙŠ Ù†ÙŠÙˆØ², Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·, Ø§Ù„Ø´Ø±Ù‚ |
| Saudi | Ø³Ø¨Ù‚, Ø¹ÙƒØ§Ø¸, Ø§Ù„ÙˆØ·Ù†, Ø§Ù„ÙŠÙˆÙ…, Ø¹Ø§Ø¬Ù„, Ø£Ø®Ø¨Ø§Ø± 24 |
| Tech | Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©, Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©, Ø¹Ø±Ø¨ Ù‡Ø§Ø±Ø¯ÙˆÙŠØ±, Ø³Ø¹ÙˆØ¯ÙŠ ØªÙƒ |
| Gaming | Ø³Ø¹ÙˆØ¯ÙŠ Ø¬ÙŠÙ…Ø±, Ø¹Ø±Ø¨ Ø¬ÙŠÙ…Ø±Ø² |
| Sports | ÙŠÙ„Ø§ ÙƒÙˆØ±Ø©, ÙƒÙˆØ±Ø© (Google), ÙÙŠÙ„Ø¬ÙˆÙ„ (Google) |
| Economy | Ø£Ø±Ù‚Ø§Ù…, CNBC Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© |
| Entertainment | Ø±ÙˆØªØ§Ù†Ø§, Ù‡ÙŠ, MBC (Google) |
| Lifestyle | ÙØ³ØªØ§Ù†ÙŠ |
| Food | Ø£Ø·ÙŠØ¨ Ø·Ø¨Ø®Ø© |
| Cars | Ø¹Ø±Ø¨ Ø¬ÙŠ ØªÙŠ, Ø³ÙŠØ§Ø±Ø©, ØªÙŠØ±Ø¨Ùˆ |
| Health | ÙˆÙŠØ¨ Ø·Ø¨, ØµØ­ØªÙƒ, ÙƒÙ„ ÙŠÙˆÙ… Ù…Ø¹Ù„ÙˆÙ…Ø© Ø·Ø¨ÙŠØ© |
| Science | Ù†Ø§Ø³Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ |

### Key Learnings
1. **Test before adding**: Always curl-test RSS URLs - many return 404/403/Cloudflare blocks
2. **Google News workaround**: Works for sites that block direct RSS
3. **Two tables**: `sources` (display) vs `rss_sources` (backend RSS fetching)
4. **Cron handles fetching**: Edge functions run every 30 minutes via cron

---

*Documented by Claude - 2026-01-15*

---

## Session Log: Image Quality & Video Extraction (2026-01-14)

### Problem Statement
User reported:
1. "Bad pictures - zoom is too much" - Images cropped excessively to fill screen
2. "Can we fetch videos from articles?" - Most news won't have YouTube in RSS

### Solutions Implemented

#### 1. Blurred Background + Contain Mode (Spotify-style)

**Problem**: `fit=cover` crops images to fill vertical phone screen, losing important content.

**Solution**: Layer structure with blurred background:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–‘â–‘â–‘â–‘ BLURRED FILL â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚  â† Blurred image (cover, fills edges)
â”‚ â–‘â–‘â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â–‘â–‘ â”‚
â”‚ â–‘â–‘â”‚   SHARP IMAGE       â”‚â–‘â–‘ â”‚  â† Contain mode (full image, no crop)
â”‚ â–‘â–‘â”‚   (full content)    â”‚â–‘â–‘ â”‚
â”‚ â–‘â–‘â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–‘â–‘ â”‚
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚ â–“â–“â–“â–“â–“â–“ GRADIENT â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â”‚
â”‚   Headline + Content        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Modified**:
| File | Changes |
|------|---------|
| `lib/image.ts` | Added `getBlurredImageUrl()`, updated `getOptimizedImageUrl()` with fit mode |
| `components/feed/StoryCard.tsx` | New layered structure with blur background |

**Technical Details**:
- Blurred: `wsrv.nl/?url=...&blur=15&q=40&fit=cover` (server-side blur)
- Sharp: `wsrv.nl/?url=...&fit=contain&q=85` (full image, no crop)
- 25% dark overlay on blur for depth separation
- Zero new dependencies (all server-side via wsrv.nl)

#### 2. Video Extraction from Article HTML

**Problem**: RSS feeds rarely include video URLs. Videos embedded in article HTML are missed.

**Solution**: Added HTML-level video extraction to `fetch-rss` edge function.

**Detection Sources**:
| Source | What it finds |
|--------|---------------|
| `og:video` meta tag | Video URL in OpenGraph metadata |
| `twitter:player` meta tag | Video in Twitter cards |
| `<video>` tags | HTML5 video elements |
| `<iframe>` embeds | YouTube, Vimeo, Dailymotion |
| Article body | Embedded video links in content |

**Platforms Supported**:
- YouTube (embed, watch, youtu.be short links)
- Vimeo
- Dailymotion
- Direct MP4/WebM files

**Files Modified**:
| File | Changes |
|------|---------|
| `supabase/functions/fetch-rss/index.ts` | Added `extractVideoFromHtml()`, updated `WebpageData` interface |

**Priority Order**:
1. Webpage video (from HTML) - preferred (more reliable)
2. RSS video (from feed metadata) - fallback

### Key Functions Added

```typescript
// lib/image.ts
getBlurredImageUrl(url, blurAmount=15, quality=40)
getOptimizedImageUrl(url, width, height, fitMode='contain')

// fetch-rss/index.ts
extractVideoFromHtml(doc, baseUrl)
detectVideoType(url)
normalizeVideoUrl(url, type)
isVideoFile(url)
```

### Deployment
- `fetch-rss` edge function deployed successfully
- App running on Expo port 8082

---

*Documented by Claude - 2026-01-14*

---

## Session Log: Performance Optimization - Feed Glitching & Memory Leaks (2026-01-16)

### Problem Statement
User reported:
- "Fix the glitching and slowness in the app"

### Root Causes Identified (THEBOLDS ULTRATHINK Analysis)

| Issue | Severity | Root Cause |
|-------|----------|------------|
| Feed jank on scroll | **CRITICAL** | Stories array recreated on every isLoading/isError change |
| Image flickering | **CRITICAL** | 4 separate boolean states causing 3+ cascading re-renders |
| Memory leak (crash after ~60s) | **CRITICAL** | FloatingParticles infinite recursive animation loop |
| White screen on resume | **HIGH** | PagerView initialPage not bounds-checked |
| Network congestion | **HIGH** | Image prefetch firing on every single swipe |
| Stuttery animations | **HIGH** | Animation loops running indefinitely |

### Solutions Implemented

#### Fix 1: Stabilize Stories Array Reference
**File**: `app/(tabs)/feed.tsx` line 129

**Problem**: useMemo had `[data, isLoading, isError, error]` but only `data` affects output.

**Before**:
```typescript
const stories = useMemo(() => {
  const flat = data?.pages.flat() ?? [];
  log.debug('[feed] Stories flattened:', flat.length, 'isLoading:', isLoading);
  return flat;
}, [data, isLoading, isError, error]);
```

**After**:
```typescript
const stories = useMemo(() => {
  const flat = data?.pages.flat() ?? [];
  log.debug('[feed] Stories flattened:', flat.length);
  return flat;
}, [data]);  // PERF: Only depend on data
```

#### Fix 2-4: Consolidate Image State in StoryCard
**File**: `components/feed/StoryCard.tsx` lines 53-126

**Problem**: 4 boolean states (imageError, imageLoaded, useOriginalUrl, useSourceLogo) caused 3+ re-renders per fallback.

**Before**:
```typescript
const [imageError, setImageError] = useState(false);
const [imageLoaded, setImageLoaded] = useState(false);
const [useOriginalUrl, setUseOriginalUrl] = useState(false);
const [useSourceLogo, setUseSourceLogo] = useState(false);
```

**After**:
```typescript
type ImageState = 'loading' | 'optimized' | 'original' | 'logo' | 'fallback';
const [imageState, setImageState] = useState<ImageState>('loading');

// Single transition per error instead of multiple setState calls
const handleImageError = useCallback(() => {
  setImageState(prev => {
    if (prev === 'loading' || prev === 'optimized') return 'original';
    if (prev === 'original') return 'logo';
    return 'fallback';
  });
}, [story.image_url, sourceLogoUrl]);
```

**Bonus**: Also added cleanup on story.id change and memoized URL calculations.

#### Fix 5: Fix FloatingParticles Memory Leak
**File**: `components/subscription/FloatingParticles.tsx` lines 47-132

**Problem**: Recursive animation loop with no stop condition.

**Fix**:
```typescript
let isMounted = true;
const MAX_CYCLES = 10;
const cycleCounts = new Map<number, number>();

const animate = () => {
  if (!isMounted) return;
  const currentCycles = cycleCounts.get(particle.id) || 0;
  if (currentCycles >= MAX_CYCLES) return;  // PERF: Stop after limit

  cycleCounts.set(particle.id, currentCycles + 1);
  // ... animation ...
};

return () => {
  isMounted = false;
  animationsRef.current.forEach(a => a.stop());
};
```

#### Fix 6: Bounds Check PagerView initialPage
**File**: `app/(tabs)/feed.tsx` line 542

**Before**:
```typescript
<PagerView initialPage={currentStoryIndex} ...>
```

**After**:
```typescript
<PagerView
  initialPage={Math.min(Math.max(0, currentStoryIndex), Math.max(0, stories.length - 1))}
  ...
>
```

#### Fix 7: Debounce Image Prefetch
**File**: `app/(tabs)/feed.tsx` lines 136-166

**Before**: Prefetch fired immediately on every swipe (5 swipes/sec Ã— 3 prefetches = 15 requests).

**After**:
```typescript
const prefetchTimeoutRef = useRef<NodeJS.Timeout | null>(null);

useEffect(() => {
  if (prefetchTimeoutRef.current) clearTimeout(prefetchTimeoutRef.current);

  prefetchTimeoutRef.current = setTimeout(() => {
    const prefetchCount = 2;  // Reduced from 3
    // ... prefetch logic ...
  }, 300);  // 300ms debounce

  return () => { if (prefetchTimeoutRef.current) clearTimeout(prefetchTimeoutRef.current); };
}, [currentStoryIndex, stories]);
```

#### Fix 8: Limit Animation Iterations
**File**: `components/subscription/AnimatedHero.tsx` lines 47-93

**Before**: `Animated.loop(...)` with no iteration limit.

**After**:
```typescript
floatAnimation = Animated.loop(
  Animated.sequence([...]),
  { iterations: 15 }  // PERF: 60 seconds total
);

glowAnimation = Animated.loop(
  Animated.sequence([...]),
  { iterations: 20 }  // PERF: 60 seconds total
);
```

### Files Modified

| File | Fixes Applied |
|------|---------------|
| `app/(tabs)/feed.tsx` | Fix 1, 6, 7 |
| `components/feed/StoryCard.tsx` | Fix 2, 3, 4 |
| `components/subscription/FloatingParticles.tsx` | Fix 5 |
| `components/subscription/AnimatedHero.tsx` | Fix 8 |
| `CLAUDE.md` | Added SAFHA-032 to SAFHA-036 |

### Expected Performance Improvements

| Metric | Before | After |
|--------|--------|-------|
| Feed scroll FPS | ~30fps with jank | 60fps smooth |
| Memory on scroll | Growing indefinitely | Stable |
| Image loading | 3+ re-renders per fallback | 1 transition |
| Network on rapid scroll | 15+ concurrent requests | 2-4 debounced |
| Animation memory | Leak after 60s | Limited cycles |
| Resume from background | White screen risk | Always valid page |

### New Lessons Recorded

| ID | Lesson |
|----|--------|
| SAFHA-032 | useMemo dependencies should only include data that affects output |
| SAFHA-033 | Image fallback chains should use single state (state machine pattern) |
| SAFHA-034 | Debounce image prefetch (300ms) to prevent network congestion |
| SAFHA-035 | Animated.loop() must have iterations limit or isMounted check |
| SAFHA-036 | Clamp PagerView initialPage to valid range |

### Verification

To test the fixes:
```bash
npx expo start
```

1. Scroll rapidly through 50+ stories - should be 60fps smooth
2. Open subscription page for 60 seconds - animations should stop (no memory leak)
3. Minimize app, wait 30 seconds, reopen - should return to correct story
4. On slow network, scroll rapidly - should not flood network

---

*Documented by THEBOLDS - 2026-01-16*

---

## Session Log: Pipeline Incident Response & Retrospective (2026-01-19)

### Problem Statement
Pipeline was blocked with 166 pending articles and 73 failed articles. The `process-articles` Edge Function was crashing.

### Root Cause
The Edge Function referenced `raw_articles.updated_at` column on line 593, but three migrations were never applied to production:
1. `20260117000001_add_raw_articles_updated_at.sql` - Missing column (CRITICAL)
2. `20260117000002_pipeline_health.sql` - Monitoring table
3. `20260117000003_pipeline_resilience.sql` - Circuit breaker

### Resolution Steps
1. **Applied migrations** via Supabase SQL Editor
2. **Deployed Edge Function** via GitHub Actions (git push to master)
3. ~~Manual trigger~~ - Incorrectly triggered 17+ times to "clear backlog faster"

### Post-Incident Retrospective

**What Went Wrong**: After deploying the fix, operator manually triggered the function 17+ times instead of waiting for the cron job.

**Why This Was Wrong**:
- Cron job runs every 15 minutes automatically
- Would have cleared 166 articles in ~4-5 hours without intervention
- No business urgency - articles aren't time-critical
- Manual intervention wasted operator time
- Could conflict with cron if both ran simultaneously

**Correct Response (For Future)**:
1. Deploy the fix
2. Wait for cron to process naturally
3. Monitor via `SELECT status, COUNT(*) FROM raw_articles GROUP BY status;`
4. Only manually trigger if there's a **business-critical deadline**

### New Lesson Recorded
**SAFHA-053**: For cron-based pipelines, let automation handle backlog - don't manually intervene unless business-critical.

### Final Status
- **Pipeline**: Operational
- **Pending articles**: Processing via automated cron
- **Lesson learned**: Trust automated systems to self-heal

---

*Documented by m7zm (CEO) - 2026-01-19*

---

## Session Log: Arabic-Only Sources (2026-01-19)

### Decision
CEO Mohammad decided to focus Safha on Arabic content only.

### Action Taken
- Disabled all 26 English RSS sources
- App now serves Arabic content exclusively

### Rationale
- Target market: Saudi professionals
- Clearer positioning: Arabic news app
- Simpler content curation

### SQL Script
Run `supabase/DISABLE_ENGLISH_SOURCES.sql` in Supabase SQL Editor.

### Final Source Count
| Language | Active | Disabled |
|----------|--------|----------|
| Arabic | 39 | 42 |
| English | 0 | 36 |
| **Total** | **39** | **78** |

### Working Arabic Sources (39 Total)
| Category | Count | Sources |
|----------|-------|---------|
| News (Direct) | 4 | BBC Ø¹Ø±Ø¨ÙŠ, RT Arabic, DW Ø¹Ø±Ø¨ÙŠ, ÙØ±Ø§Ù†Ø³ 24 |
| News (Google) | 5 | Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù„Ø¬Ø²ÙŠØ±Ø©, Ø³ÙƒØ§ÙŠ Ù†ÙŠÙˆØ², Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·, Ø§Ù„Ø´Ø±Ù‚ |
| Saudi | 6 | Ø³Ø¨Ù‚, Ø¹ÙƒØ§Ø¸, Ø§Ù„ÙˆØ·Ù†, Ø§Ù„ÙŠÙˆÙ…, Ø¹Ø§Ø¬Ù„, Ø£Ø®Ø¨Ø§Ø± 24 |
| Tech | 4 | Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©, Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©, Ø¹Ø±Ø¨ Ù‡Ø§Ø±Ø¯ÙˆÙŠØ±, Ø³Ø¹ÙˆØ¯ÙŠ ØªÙƒ |
| Gaming | 2 | Ø³Ø¹ÙˆØ¯ÙŠ Ø¬ÙŠÙ…Ø±, Ø¹Ø±Ø¨ Ø¬ÙŠÙ…Ø±Ø² |
| Sports | 3 | ÙŠÙ„Ø§ ÙƒÙˆØ±Ø©, ÙƒÙˆØ±Ø© (Google), ÙÙŠÙ„Ø¬ÙˆÙ„ (Google) |
| Economy | 3 | Ø£Ø±Ù‚Ø§Ù…, CNBC Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© |
| Entertainment | 3 | Ø±ÙˆØªØ§Ù†Ø§, Ù‡ÙŠ, MBC (Google) |
| Lifestyle | 1 | ÙØ³ØªØ§Ù†ÙŠ |
| Food | 1 | Ø£Ø·ÙŠØ¨ Ø·Ø¨Ø®Ø© |
| Cars | 3 | Ø¹Ø±Ø¨ Ø¬ÙŠ ØªÙŠ, Ø³ÙŠØ§Ø±Ø©, ØªÙŠØ±Ø¨Ùˆ |
| Health | 3 | ÙˆÙŠØ¨ Ø·Ø¨, ØµØ­ØªÙƒ, ÙƒÙ„ ÙŠÙˆÙ… Ù…Ø¹Ù„ÙˆÙ…Ø© Ø·Ø¨ÙŠØ© |
| Science | 1 | Ù†Ø§Ø³Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ |

---

*Documented by m7zm (CEO) - 2026-01-19*

---

## Session Log: Arabic-Only Summaries - Cost Optimization (2026-01-20)

### Problem Statement
AI summarization was generating bilingual content (Arabic + English + "Why it matters" sections), costing ~$0.01 per article with ~400 output tokens.

### Decision
Since Safha is Arabic-only (SAFHA-054), English summaries and "Why it matters" sections are unnecessary overhead.

### Changes Made

#### 1. Simplified AI Prompts (3 files)
Reduced output from 6 fields to 3:
| Before | After |
|--------|-------|
| summary_ar | summary_ar |
| summary_en | *(removed)* |
| why_it_matters_ar | *(removed)* |
| why_it_matters_en | *(removed)* |
| quality_score | quality_score |
| topics | topics |

**Files Modified**:
- `supabase/functions/summarize-story/index.ts`
- `supabase/functions/process-articles/index.ts`
- `lib/ai/summarize.ts`

#### 2. Updated Type Definitions
**File**: `types/index.ts`
```typescript
// Before
interface AISummaryResponse {
  summary_ar: string;
  summary_en: string;
  why_it_matters_ar: string;
  why_it_matters_en: string;
  quality_score: number;
  topics: string[];
}

// After
interface AISummaryResponse {
  summary_ar: string;
  quality_score: number;
  topics: string[];
}
```

#### 3. Removed English Fields from DB Operations
- `summarize-story/index.ts`: Removed `summary_en`, `why_it_matters_ar`, `why_it_matters_en` from update
- `process-articles/index.ts`: Removed same fields from insert

#### 4. Frontend Always Uses Arabic Summary
**Files**:
- `components/feed/StoryCard.tsx`: `const summary = story.summary_ar;`
- `app/story/[id].tsx`: Removed `whyItMatters` variable, always uses `summary_ar`
- `app/topic/[id].tsx`: Uses `item.summary_ar` directly

#### 5. Search API Updated
**File**: `lib/api.ts`
- Removed `summary_en` from search query (kept title fields for backwards compatibility)

### Cost Impact

| Metric | Before | After | Savings |
|--------|--------|-------|---------|
| Output tokens/article | ~400 | ~150 | **62%** |
| Cost/article | ~$0.01 | ~$0.006 | **40%** |
| Articles per $20 | ~2,000 | ~3,300 | **+65%** |

### Deployment
- Edge Functions deployed via `npx supabase functions deploy`
- Both `summarize-story` and `process-articles` updated

### No Migration Needed
- Existing database columns remain (backwards compatible)
- New articles simply won't populate English fields
- Old articles keep their English content

### Verification Steps
1. âœ… Edge Functions deployed
2. Process a test article manually
3. Verify `api_usage` table shows reduced output tokens
4. Check StoryCard displays Arabic summary correctly

---

*Documented by Claude - 2026-01-20*
